<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relações Públicas do Complexo - Simulador v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .blood-vial {
            border: 2px solid #4b5563;
            border-radius: 10px 10px 50px 50px;
            height: 150px;
            width: 80px;
            position: relative;
            background: linear-gradient(to top, rgba(255,255,255,0.1) 5%, transparent 5%);
            overflow: hidden;
        }
        .blood-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80%;
            border-radius: 0 0 45px 45px;
            transition: all 0.5s ease-in-out;
        }
        .bg-healthy { background-color: #dc2626; }
        .bg-met-virus { 
            background-color: #374151;
            animation: bubble 2s linear infinite;
        }
        .bg-met-rx { 
            background-color: #22d3ee;
            box-shadow: 0 0 15px #22d3ee;
        }
        .bg-fusion-bad {
            background-color: #581c87;
            animation: bubble-fast 1s linear infinite;
        }
        .bg-fusion-good {
            background: linear-gradient(180deg, #be185d 0%, #86198f 100%);
        }
        .bg-cure-complete {
            background: linear-gradient(180deg, #fde047 0%, #facc15 100%);
            animation: glow 1.5s infinite alternate;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .scenario-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .scenario-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--glow-color);
        }
        .progress-bar {
            background-color: #374151;
            border-radius: 8px;
            overflow: hidden;
            height: 20px;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-10 border-b-2 border-cyan-500/30 pb-4">
            <h1 class="font-orbitron text-4xl md:text-5xl font-bold text-cyan-400">Relações Públicas do Complexo</h1>
            <p class="text-lg text-gray-400 mt-2">Simulador de Crise Viral-Radioativa v2</p>
        </header>

        <!-- Main Menu -->
        <section id="main-menu">
            <h2 class="text-2xl font-semibold mb-6 text-center">Selecione o Cenário da Simulação</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="selectScenario('fusion')" class="scenario-card cursor-pointer bg-gray-800 p-6 rounded-lg border-2 border-pink-500" style="--glow-color: #ec4899;">
                    <h3 class="font-orbitron text-xl font-bold text-pink-400 mb-2">Fusão Viral</h3>
                    <p class="text-sm text-gray-400">Teste a fusão do MET-Vírus25 com sangue saudável ou o antídoto MET-RX em laboratório.</p>
                </div>
                <div onclick="selectScenario('containment')" class="scenario-card cursor-pointer bg-gray-800 p-6 rounded-lg border-2 border-green-500" style="--glow-color: #22c55e;">
                    <h3 class="font-orbitron text-xl font-bold text-green-400 mb-2">Contenção Ambiental</h3>
                    <p class="text-sm text-gray-400">Aplique estratégias de contenção em amostras de solo e água contaminados com Urânio-235.</p>
                </div>
                <div onclick="selectScenario('patient')" class="scenario-card cursor-pointer bg-gray-800 p-6 rounded-lg border-2 border-yellow-500" style="--glow-color: #eab308;">
                    <h3 class="font-orbitron text-xl font-bold text-yellow-400 mb-2">Tratamento de Pacientes</h3>
                    <p class="text-sm text-gray-400">Administre o MET-RX em pacientes humanos em diferentes estágios de contaminação.</p>
                </div>
            </div>
        </section>

        <!-- Dynamic Simulation Steps will be injected here -->
        <div id="simulation-content"></div>

        <div class="text-center mt-12">
            <button id="back-to-menu-btn" onclick="resetToMenu()" class="hidden btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg">
                Voltar ao Menu Principal
            </button>
        </div>
    </div>

    <script>
        let currentScenario = null;
        let simulationState = {};

        const ui = {
            mainMenu: document.getElementById('main-menu'),
            simulationContent: document.getElementById('simulation-content'),
            backToMenuBtn: document.getElementById('back-to-menu-btn'),
        };

        const contaminationData = {
            1: { name: 'Nível 1 – Leve', details: 'pH: levemente ácido (6,5 – 6,8). Viscosidade: quase normal. Efeito no corpo: náuseas leves, tontura.' },
            2: { name: 'Nível 2 – Moderada', details: 'pH: ácido (5,5 – 6,0). Viscosidade: com microbolhas. Efeito no corpo: queimaduras leves, vômito, febre.' },
            3: { name: 'Nível 3 – Grave', details: 'pH: muito ácido (4,5 – 5,0). Viscosidade: aspecto espesso, quase oleoso. Efeito no corpo: queimaduras químicas graves, infecção rápida.' },
            4: { name: 'Nível 4 – Crítica', details: 'pH: extremamente ácido (≤ 4,0). Viscosidade: densa, quase como um gel negro. Efeito no corpo: infecção imediata e fatal.' }
        };

        const patientStages = {
            1: { name: 'Estágio 1 - Inicial', details: 'Náuseas, tontura, irritação ocular. Prognóstico reversível.' },
            2: { name: 'Estágio 2 - Progressivo', details: 'Queimaduras cutâneas, queda de cabelo. Risco de sequelas.' },
            3: { name: 'Estágio 3 - Avançado', details: 'Agressividade, confusão, delírios. Alto risco de morte.' },
            4: { name: 'Estágio 4 - Crítico', details: 'Inconsciência, convulsões, falência de órgãos. Quase irreversível.' },
            5: { name: 'Estágio 5 - Terminal/Mutagênico', details: 'Ataques de pânico, força anormal, psique animalizada. Fatal.' }
        };

        function selectScenario(scenario) {
            currentScenario = scenario;
            ui.mainMenu.classList.add('hidden');
            ui.backToMenuBtn.classList.remove('hidden');
            simulationState = { log: [] }; // Reset state
            
            switch(scenario) {
                case 'fusion':
                    renderFusionSetup();
                    break;
                case 'containment':
                    renderContainmentSetup();
                    break;
                case 'patient':
                    renderPatientSetup();
                    break;
            }
        }

        function resetToMenu() {
            currentScenario = null;
            ui.simulationContent.innerHTML = '';
            ui.mainMenu.classList.remove('hidden');
            ui.backToMenuBtn.classList.add('hidden');
        }
        
        // Render Functions for each scenario
        function renderFusionSetup() {
             ui.simulationContent.innerHTML = `
                <section id="contamination-level-step">
                    <h2 class="text-2xl font-semibold mb-6 text-center">1. Selecione o Nível de Contaminação da Chuva (CHV)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        ${Object.keys(contaminationData).map(level => `
                            <div onclick="setupFusionSim(${level})" class="scenario-card cursor-pointer bg-gray-800 p-6 rounded-lg border-2 border-gray-600 hover:border-cyan-500">
                                <h3 class="font-orbitron text-xl font-bold text-cyan-400 mb-2">Nível ${level}</h3>
                                <p class="text-sm text-gray-400">${contaminationData[level].name.split('–')[1].trim()}</p>
                            </div>
                        `).join('')}
                    </div>
                </section>
                <div id="fusion-sim-content"></div>`;
        }

        function renderContainmentSetup() {
            simulationState.environmentalContamination = 85; // Starting high
            ui.simulationContent.innerHTML = `
                <section id="containment-sim">
                    <h2 class="text-2xl font-bold text-center mb-2">Simulação: Contenção Ambiental</h2>
                    <div class="text-center bg-gray-800/50 border border-gray-700 rounded-lg p-3 mb-6 max-w-4xl mx-auto">
                        <h4 class="font-orbitron text-lg">Cenário</h4>
                        <p class="text-sm text-gray-400">Amostras de solo e água próximas ao local da queda do meteoro apresentam alta concentração de Urânio-235, metais pesados e resíduos. A radiação local é de 320-450 µSv/h.</p>
                    </div>
                    
                    <div class="text-center text-2xl font-orbitron text-red-400 mb-8">
                        Nível de Contaminação Ambiental: <span id="env-contamination-level">${simulationState.environmentalContamination}%</span>
                        <div class="progress-bar mt-2 max-w-lg mx-auto"><div id="env-contamination-bar" class="progress-bar-fill bg-red-500" style="width: ${simulationState.environmentalContamination}%;"></div></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="tests-division">
                        ${renderTestCards(['cie', 'etc', 'lid', 'car'])}
                    </div>
                    <div id="results-log" class="mt-8 bg-gray-900/50 p-4 rounded-lg"></div>
                </section>`;
        }

        function renderPatientSetup() {
             ui.simulationContent.innerHTML = `
                <section id="patient-stage-step">
                    <h2 class="text-2xl font-semibold mb-6 text-center">1. Selecione o Estágio de Contaminação do Paciente</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${Object.keys(patientStages).map(stage => `
                            <div onclick="setupPatientSim(${stage})" class="scenario-card cursor-pointer bg-gray-800 p-6 rounded-lg border-2 border-gray-600 hover:border-yellow-500">
                                <h3 class="font-orbitron text-xl font-bold text-yellow-400 mb-2">${patientStages[stage].name}</h3>
                                <p class="text-sm text-gray-400">${patientStages[stage].details}</p>
                            </div>
                        `).join('')}
                    </div>
                </section>
                <div id="patient-sim-content"></div>`;
        }
        
        // Simulation Setup functions
        function setupFusionSim(level) {
            simulationState.contaminationLevel = level;
            document.getElementById('contamination-level-step').classList.add('hidden');
            document.getElementById('fusion-sim-content').innerHTML = `
                <div class="text-center mt-10">
                    <h2 class="text-2xl font-semibold mb-6">2. Selecione o Procedimento de Fusão</h2>
                    <div class="flex flex-col md:flex-row justify-center items-center gap-6">
                        <button onclick="runFusionSim('healthy')" class="btn bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-full md:w-auto">
                            Fusão com Sangue Saudável
                        </button>
                        <button onclick="runFusionSim('curative')" class="btn bg-cyan-500 hover:bg-cyan-400 text-black font-bold py-3 px-6 rounded-lg w-full md:w-auto">
                            Fusão com Sangue Curativo (MET-RX)
                        </button>
                    </div>
                </div>`;
        }

        function setupPatientSim(stage) {
            simulationState.patientStage = stage;
            simulationState.patientStatus = patientStages[stage].name;
            document.getElementById('patient-stage-step').classList.add('hidden');
            document.getElementById('patient-sim-content').innerHTML = `
                 <section id="patient-treatment-sim">
                    <h2 class="text-2xl font-bold text-center mb-2">Simulação: Tratamento de Paciente</h2>
                    <div id="patient-status-display" class="text-center text-2xl font-orbitron text-yellow-300 mb-8">
                        Status do Paciente: <span id="patient-status-text">${simulationState.patientStatus}</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="tests-division">
                        ${renderTestCards(['cie', 'etc', 'lid', 'car'])}
                    </div>
                    <div id="results-log" class="mt-8 bg-gray-900/50 p-4 rounded-lg"></div>
                </section>`;
        }


        // Main Simulation Runners
        function runFusionSim(type) {
             simulationState.fusionType = type;
             if (type === 'curative') {
                 simulationState.curePercentage = 68;
             } else {
                 simulationState.curePercentage = 0;
             }

             const config = {
                healthy: { title: 'Fusão: Sangue Saudável + MET-Vírus25' },
                curative: { title: 'Fusão: Sangue Curativo MET-RX + MET-Vírus25' }
             };

            document.getElementById('fusion-sim-content').innerHTML = `
                <h2 class="text-2xl font-bold text-center mb-2">${config[type].title}</h2>
                <div class="text-center bg-gray-800/50 border border-gray-700 rounded-lg p-3 mb-6 max-w-4xl mx-auto">
                    <h4 class="font-orbitron text-lg">CHV ${contaminationData[simulationState.contaminationLevel].name}</h4>
                    <p class="text-sm text-gray-400">${contaminationData[simulationState.contaminationLevel].details}</p>
                </div>
                ${type === 'curative' ? `<div id="cure-percentage-display" class="text-center text-2xl font-orbitron text-yellow-300 mb-8">Eficiência da Cura: ${simulationState.curePercentage}%</div>` : ''}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="tests-division">
                    ${renderTestCards(['cie', 'etc', 'lid', 'car'])}
                </div>
                <div id="results-log" class="mt-8 bg-gray-900/50 p-4 rounded-lg"></div>
                <div class="text-center mt-10">
                    <button onclick="showFusionResults()" class="btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-lg text-lg">
                        Finalizar e Ver Resultados
                    </button>
                </div>`;
        }

        function showFusionResults() {
            let resultTitle, resultContentClass;
            const { fusionType, curePercentage } = simulationState;

            if (fusionType === 'healthy') {
                resultTitle = "ALERTA: Fusão Instável Concluída";
                resultContentClass = 'bg-fusion-bad';
            } else {
                if (curePercentage >= 100) {
                    resultTitle = "CURA COMPLETA! O VÍRUS FOI NEUTRALIZADO!";
                    resultContentClass = 'bg-cure-complete';
                } else if (curePercentage >= 50) {
                    resultTitle = `NEUTRALIZAÇÃO PARCIAL: Eficiência final de ${curePercentage}%`;
                    resultContentClass = 'bg-fusion-good';
                } else {
                    resultTitle = `FALHA NA NEUTRALIZAÇÃO: Eficiência final de ${curePercentage}%`;
                    resultContentClass = 'bg-fusion-bad';
                }
            }
            
            ui.simulationContent.innerHTML = `
                <section class="text-center">
                    <h2 class="text-3xl font-bold mb-6">${resultTitle}</h2>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-8 bg-gray-800 p-8 rounded-lg border-2 border-gray-700">
                        <div class="text-center">
                            <div class="blood-vial mx-auto" style="height: 200px; width: 100px;">
                                <div class="blood-content ${resultContentClass}"></div>
                            </div>
                            <p class="mt-2 font-semibold">Amostra Resultante</p>
                        </div>
                        <div class="text-left max-w-2xl w-full">
                            <h3 class="text-2xl font-semibold mb-4">Relatório de Ações</h3>
                            <div class="space-y-3 text-gray-300 max-h-96 overflow-y-auto pr-4">${renderLog()}</div>
                        </div>
                    </div>
                </section>`;
        }
        
        // Helper functions
        function renderTestCards(tests) {
            const testInfo = {
                cie: { color: 'cyan', description: 'Descreva sua ação científica de análise.' },
                etc: { color: 'red', description: 'Como você mantém o controle e a segurança?' },
                lid: { color: 'yellow', description: 'Qual sua ordem ou estratégia para a equipe?' },
                car: { color: 'green', description: 'Como você documenta ou comunica os achados?' }
            };
            return tests.map(test => `
                <div class="bg-gray-800 p-6 rounded-lg border-2 border-gray-700">
                    <h3 class="font-orbitron text-xl font-bold text-${testInfo[test].color}-400 mb-2">${test.toUpperCase()}</h3>
                    <p class="text-gray-400 mb-4 text-sm">${testInfo[test].description}</p>
                    <input type="text" id="${test}-input" class="w-full bg-gray-900 border border-gray-600 rounded p-2 mb-3 text-white" placeholder="Descreva a ação...">
                    <button onclick="runAITest('${test}')" class="btn w-full bg-${testInfo[test].color}-600 hover:bg-${testInfo[test].color}-500 text-white font-bold py-2 px-4 rounded flex items-center justify-center gap-2">
                        <span class="text-btn">Executar</span> <div class="loader hidden"></div>
                    </button>
                </div>
            `).join('');
        }
        
        function renderLog() {
            if (simulationState.log.length === 0) return "<p>Nenhuma ação foi registrada.</p>";
            return simulationState.log.map(log => `
                <div class="p-3 bg-gray-900/50 rounded-lg border-l-4 ${log.success ? 'border-green-500' : 'border-red-500'}">
                    <p><strong>Teste ${log.test}:</strong> ${log.action}</p>
                    <p class="text-sm italic">"${log.narrative}"</p>
                    <p class="text-sm font-semibold text-yellow-300">Efeito: ${log.mechanic}</p>
                </div>
            `).join('');
        }

        async function runAITest(testType) {
            const input = document.getElementById(`${testType}-input`);
            const actionDescription = input.value.trim();
            if (!actionDescription) {
                alert('Por favor, descreva a sua ação.');
                return;
            }

            const button = input.nextElementSibling;
            const buttonText = button.querySelector('.text-btn');
            const loader = button.querySelector('.loader');

            button.disabled = true;
            buttonText.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const apiUrl = `/.netlify/functions/gemini-proxy`;
                const { systemPrompt, userPrompt } = buildPrompts(testType, actionDescription);

                const payload = {
                    userPrompt, systemPrompt,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "success": { "type": "BOOLEAN" },
                                "narrative": { "type": "STRING" },
                                "mechanic": { "type": "STRING" }
                            },
                             required: ["success", "narrative", "mechanic"]
                        }
                    }
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Resposta inválida do servidor.' }));
                    throw new Error(errorData.error || `Erro na chamada da função: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (result.error) throw new Error(result.error);

                const aiResult = JSON.parse(result.candidates[0].content.parts[0].text);
                simulationState.log.push({ test: testType.toUpperCase(), action: actionDescription, ...aiResult });

                updateSimulationState(aiResult.mechanic);
                document.getElementById('results-log').innerHTML = renderLog();

            } catch (error) {
                console.error("Erro na IA:", error);
                alert(`Erro de comunicação: ${error.message}. Verifique a configuração da função Netlify e a API key.`);
            } finally {
                input.value = '';
                button.disabled = false;
                buttonText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }
        
        function updateSimulationState(mechanic) {
            switch(currentScenario) {
                case 'fusion':
                    if (simulationState.fusionType === 'curative') {
                        const change = mechanic.match(/([+-])\s*(\d+)\s*%/);
                        if (change) {
                            const value = parseInt(change[2], 10);
                            simulationState.curePercentage += (change[1] === '+' ? value : -value);
                            simulationState.curePercentage = Math.max(0, Math.min(100, simulationState.curePercentage));
                            document.getElementById('cure-percentage-display').textContent = `Eficiência da Cura: ${simulationState.curePercentage}%`;
                        }
                    }
                    break;
                case 'containment':
                    const change = mechanic.match(/([+-])\s*(\d+)\s*%/);
                    if (change) {
                        const value = parseInt(change[2], 10);
                        simulationState.environmentalContamination += (change[1] === '+' ? value : -value);
                        simulationState.environmentalContamination = Math.max(0, Math.min(100, simulationState.environmentalContamination));
                        const levelEl = document.getElementById('env-contamination-level');
                        const barEl = document.getElementById('env-contamination-bar');
                        levelEl.textContent = `${simulationState.environmentalContamination}%`;
                        barEl.style.width = `${simulationState.environmentalContamination}%`;
                        if(simulationState.environmentalContamination < 30) barEl.className = 'progress-bar-fill bg-green-500';
                        else if(simulationState.environmentalContamination < 60) barEl.className = 'progress-bar-fill bg-yellow-500';
                        else barEl.className = 'progress-bar-fill bg-red-500';
                    }
                    break;
                case 'patient':
                    const stageChange = mechanic.match(/paciente (melhora|piora|estabiliza)/i);
                    if (stageChange) {
                        const outcome = stageChange[1].toLowerCase();
                        if (outcome === 'melhora') {
                            simulationState.patientStage = Math.max(1, simulationState.patientStage - 1);
                        } else if (outcome === 'piora') {
                            simulationState.patientStage = Math.min(5, simulationState.patientStage + 1);
                        }
                        simulationState.patientStatus = patientStages[simulationState.patientStage].name;
                        if(mechanic.includes("morte") || mechanic.includes("fatal")) {
                            simulationState.patientStatus = "ÓBITO";
                        }
                         document.getElementById('patient-status-text').textContent = simulationState.patientStatus;
                    }
                    break;
            }
        }

        function buildPrompts(testType, actionDescription) {
            let systemPrompt = `Você é um mestre de jogo para um RPG de ficção científica. O cenário é um complexo tentando resolver uma crise viral-radioativa causada pela queda de um meteoro com Urânio-235. Sua tarefa é gerar resultados narrativos e mecânicos para as ações dos jogadores. A resposta DEVE ser um objeto JSON válido.`;
            let userPrompt = `Ação do Jogador: Teste ${testType.toUpperCase()} - "${actionDescription}".\n`;
            
            switch(currentScenario) {
                case 'fusion':
                    systemPrompt += `O efeito mecânico deve ser uma alteração percentual na cura (ex: "+5% de cura") se a simulação for curativa, ou um efeito de recurso (ex: "BI -1") caso contrário.`;
                    userPrompt += `Cenário: Fusão em laboratório. CHV Nível ${simulationState.contaminationLevel}. Fusão com ${simulationState.fusionType}. Eficiência de cura atual: ${simulationState.curePercentage}%.`;
                    break;
                case 'containment':
                    systemPrompt += `O efeito mecânico deve ser uma alteração percentual no Nível de Contaminação Ambiental (ex: "-10% de contaminação").`;
                    userPrompt += `Cenário: Contenção ambiental de solo e água com Urânio-235. Nível de contaminação atual: ${simulationState.environmentalContamination}%.`;
                    break;
                case 'patient':
                    systemPrompt += `O efeito mecânico deve ser uma alteração no estado do paciente (ex: "paciente melhora", "paciente piora", "paciente estabiliza"). O resultado pode ser fatal.`;
                    userPrompt += `Cenário: Tratamento de um paciente humano. Estado atual: ${simulationState.patientStatus}.`;
                    break;
            }
            return { systemPrompt, userPrompt };
        }

    </script>
</body>
</html>
